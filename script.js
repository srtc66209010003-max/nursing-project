document.addEventListener("DOMContentLoaded", () => {
    // 1. ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Element ‡∏ï‡πà‡∏≤‡∏á‡πÜ
    const fullname = document.getElementById("fullname");
    const phone = document.getElementById("phone");
    const statusBox = document.getElementById("statusMessage");
    const recordSection = document.getElementById("recordSection");
    const lockOverlay = document.getElementById("lockOverlay");
    const historySection = document.getElementById("historySection");
    const historyBody = document.getElementById("historyBody");
    const btnSave = document.getElementById("btnSave");
    const btnReset = document.getElementById("btnReset");

    // 2. URL ‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏õ (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤)
    const scriptURL = 'https://script.google.com/macros/s/AKfycby69houENixc-pQplsHDsu1RHkYKWuwlvF04DzG6yQfnACOAUyX8ma1o0A2TgJudd76/exec';

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LocalStorage
    function getSavedData() {
        const data = localStorage.getItem("medicalRecords");
        return data ? JSON.parse(data) : [];
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    function refreshHistory() {
        const nameVal = fullname.value.trim();
        const phoneVal = phone.value.trim();
        if (!nameVal || !phoneVal) return;

        const allRecords = getSavedData();
        const myHistory = allRecords.filter(r => r.name === nameVal && r.phone === phoneVal);

        historyBody.innerHTML = "";
        if (myHistory.length > 0) {
            const latest = myHistory[myHistory.length - 1]; 
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td style="font-weight: bold; color: #9b1c1c;">${latest.date}</td>
                <td>${latest.symptom} ${latest.more ? '(' + latest.more + ')' : ''}</td>
                <td>${latest.medicine}</td>
                <td>${latest.level} / ${latest.dept}</td>
            `;
            historyBody.appendChild(tr);
            historySection.classList.remove("hidden");
        } else {
            historySection.classList.add("hidden");
        }
    }

    // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ü‡∏≠‡∏£‡πå‡∏°
    function checkIdentity() {
        if (fullname.value.trim() !== "" && phone.value.trim() !== "") {
            recordSection.classList.add("active");
            statusBox.innerHTML = `‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Ñ‡∏∏‡∏ì ${fullname.value.trim()}`;
            statusBox.style.background = "#e8f5e9";
            statusBox.style.color = "#2e7d32";
            refreshHistory();
        } else {
            recordSection.classList.remove("active");
            statusBox.innerHTML = "üì¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            statusBox.style.background = "#fff5f5";
            statusBox.style.color = "#9b1c1c";
            historySection.classList.add("hidden");
        }
    }

    // 5. ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
    btnSave.addEventListener("click", async () => {
        const symptom = document.getElementById("symptom").value;
        if (!symptom) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö");

        // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà Apps Script ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        const newRecord = {
            name: fullname.value.trim(),
            phone: phone.value.trim(),
            date: new Date().toLocaleString("th-TH"), 
            gender: document.getElementById("gender").value,
            dept: document.getElementById("department").value,
            level: document.getElementById("level").value,
            rest: document.getElementById("rest").value,
            symptom: symptom,
            more: document.getElementById("moreDetails").value,
            medicine: document.getElementById("medicine").value,
            temp: document.getElementById("temp").value,
            weight: document.getElementById("weight").value
        };

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        btnSave.disabled = true;
        btnSave.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        statusBox.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets...";

        try {
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°)
            let allRecords = getSavedData();
            allRecords = allRecords.filter(r => !(r.name === newRecord.name && r.phone === newRecord.phone));
            allRecords.push(newRecord);
            localStorage.setItem("medicalRecords", JSON.stringify(allRecords));

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Apps Script
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(newRecord)
            });
            
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå)
            document.querySelectorAll("#recordSection input, #recordSection select").forEach(el => {
                if(el.id !== "fullname" && el.id !== "phone") {
                    el.value = (el.id === "rest") ? "‡πÑ‡∏°‡πà‡∏°‡∏µ" : "";
                }
            });
            
            refreshHistory();
            checkIdentity(); 
        } catch (error) {
            console.error(error);
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ ‡πÅ‡∏ï‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
        } finally {
            btnSave.disabled = false;
            btnSave.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤";
        }
    });

    // 6. ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Reset)
    if (btnReset) {
        btnReset.addEventListener("click", () => {
            if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                fullname.value = "";
                phone.value = "";
                document.querySelectorAll("#recordSection input, #recordSection select, #recordSection textarea").forEach(el => {
                    el.value = "";
                });
                checkIdentity();
            }
        });
    }

    // 7. Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
    fullname.addEventListener("input", checkIdentity);
    phone.addEventListener("input", checkIdentity);
    
    lockOverlay.addEventListener("click", () => {
        if (!recordSection.classList.contains("active")) {
            alert("üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!");
            fullname.focus();
        }
    });
});
